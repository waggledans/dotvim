= mem structures =
* Oracle instance = (server - instance connected to DB) instance means memory + proc that supports 1 DB 
  basically a bunch of memory objects required to tap into DB
* RAC (Real Application Cluster)
  a bunch of instances connected to DB
* System Global Area - SGA
  ** DB buffer: Scratch space for SQL
  ** Buffer cache: area in memory stores data blocks
  ** Log buffer
  ** Shared pool:  cache
* PGA - Prog global area
  One server process per user session
== Retrieve  parameters ==
  show parameter db_name
  show parameter instance_name
  show parameter db_block_size
  select file_name, bytes/1024/1024 "MB" FROM dba_data_files ORDER BY 1;
  select member, status, group# FROM v$logfile;
= processes =
ckpt - checkpoint
dbw0 - db writer
lgw  - log writer
arc  - archiver
pmon - process monitor
smon - system monitor
= administration =
* create role
== grant user ==
Grant select on table_name to user;
alter user hr identified by hr account unlock;
grant debug connect session to hr; 
grant debug any procedure to hr
P_SEND_ADD_REGISTRATION
== Grant user SELECT on all tables in schema ==
    FOR x IN (SELECT * FROM user_tables)
    LOOP   
    EXECUTE IMMEDIATE 'GRANT SELECT ON ' || x.table_name || ' TO <<someone>>'; 
    END LOOP;
  or
    SQL> SET PAGESIZE 1000
    SQL> SELECT 'GRANT SELECT, UPDATE, DELETE ON '||TABLE_NAME||' TO <USERNAME>;' FROM USER_TABLES;
== TABLESPACE management==    
  SELECT tablespace_name, logging FROM dba_tablespaces;
  SELECT name FROM v$tablespace;
  SELECT name FROM v$datafile;
-- Create tablespace  
  CREATE TABLESPACE nologin DATAFILE /u01/oracle_home1/oradata/NEWDB/nologin.log size 10m nologging;
  
=== TEMPORARY TABLESPACE MANAGEMENT ===
-- see all temp files
    select * from dba_temp_files;
-- check for default temp tablespace:    
select property_value from database_properties where property_name like '%DEFAULT_TEMP_TABLESPACE%';
-- add tempfile 
-- check the current tempfile:
    SELECT name FROM v$tempfile;
-- create a new one (if the query didnt return anything)
    ALTER TABLESPACE temp ADD TEMPFILE '/tmp/name.dbf' SIZE 1024M AUTOEXTEND ON;
== useful commands ==
show user     : to see whoami
SELECT table_name FROM user_tables;
DESC  some_table_name;	      : to see the table columns
* check constraints (dba_constrains for the whole system)
  SELECT constraint_name, constraint_type FROM user_constraints WHERE table_name='CITIES';
P  - primary key
R  - foreign key
  SELECT column_name, position FROM user_cons_columns WHERE constraint_name='pk_cities'; 
or together:
  SELECT constraint_name, column_name, position FROM user_cons_columns WHERE constraint_name IN
	(SELECT constraint_name, constraint_type FROM user_constraints WHERE table_name='CITIES');
-- get information about table's columns:w

SELECT column_name, column_default, column_type, nullable FROM user_tab_columns WHERE table_name='person';
-- query for foreign key constraint
    SELECT a.constraint_name, a.constraint_type, column_name, r_constraint_name
    FROM user_constraints a, user_cons_columns b, 
    WHERE a.constraint_name = b.constraint_name AND a.table_name='PERSON';

== First login ==
sudo service oracle-xe start
sudo usermod -a -G dba YOURUSERNAME
sqlplus sys as sysdba
create user USERNAME identified by PASSWORD;
* if the prev step doesnt work:
  alter database open resetlogs;
grant connect, resource to USERNAME;

alter user hr identified by hr account unlock;
grant debug connect session to hr; 
GRANT CREATE PROCEDURE TO hr;
GRANT ALTER ANY PROCEDURE TO hr;
GRANT EXECUTE ON <schema_name>.<procedure_name> TO hr;
grant debug any procedure to hr
alter user <username> default tablespace <tablespace_name>;
alter user <username> temporary tablespace <temp tablespace_name>;

* Install demo (? means ORACLE_HOME, @ means compile (and execute?))
SQL> @?/demo/schema/human_resources/hr_main.sql


* Config TNS listener in $ORACLE_HOME/network/admin/tnsnames.ora
Example:
ORCLDB =
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = ubuntu-VirtualBox)(PORT = 5500))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = orcldb)
    )
  )
  

= System queries =
===cdb vs pdb (container DB) ===
> sqlplus / as sysdba
SQL> SELECT instance_name, version, status, con_id FROM v$instance;
SQL> SELECT NAME, OPEN_MODE, RESTRICTED, OPEN_TIME FROM V$PDBS;
-- if there are PDB available, move into one:
SQL> alter session set container=orclpdb;
-- Instead of selecting INSTANCE_NAME from V$INSTANCE;
-- use the following SHOW commands: SHOW CON_ID & SHOW CON_NAME:
SQL> con_id    --> CON_ID | 3
SQL> show con_name  --> CON_NAME |  PDB1
-- desc v$pdbs;

http://razorsql.com/articles/oracle_system_queries.html
 * Find all procedures
SELECT * FROM ALL_OBJECTS WHERE OBJECT_TYPE IN ('FUNCTION','PROCEDURE','PACKAGE')
SELECT * FROM ALL_OBJECTS WHERE OBJECT_TYPE IN ('FUNCTION','PROCEDURE','PACKAGE') AND OWNER='USER'
== search text in procedures ==
http://www.zilckh.com/how-to-search-a-text-in-stored-procedure-trigger-function-or-view/
    SELECT * FROM ALL_source WHERE UPPER(text) LIKE '%BLAH%'
OR:
    SELECT * FROM DBA_source WHERE UPPER(text) LIKE '%BLAH%'
The difference is dba_source will have the text of all stored objects. 
All_source will have the text of all stored objects accessible by the user performing the query. 

exit;

