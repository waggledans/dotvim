# NETBATCH:  NB
alias net 'nbq -P iil_design -C SLES10 -Q all_4 -N'
alias nbst  '~dsobel/bin/utils/netbatch/netstat \!*'
alias nb    '~gsamasov/myscripts/perl/Tk/nbqstatus_viewer.pl\!*'
setenv NBPOOL iil_design; setenv NBSLOT  all_8; setenv NBQSLOT 666;


###### Query:
ibi ibiquery data --table FINISHED_JOBS_LAST60DAYS --fields exitstatus,fullid,queue,task,class,qslot,user,workstationfullhostname,cmdname,submittime,starttime,finishtime,iterationsubmittime,utime,stime,wtime,name,actualclassreservation,maxrss,maxvmsize --filter "user='msotman'" > /tmp/ibiquery_msotman_20130129_60D.csv



Classes:
nbqrm -a -Msles_exp -Q5 228318356   resubmit job ID228318356   to sles_exp pool

nbq.pl -remote -host icsl8108 -port 54771
Netbatch   nbq -Psles_idc -Cx86_64
Remove netbatch job: /usr/intel/bin/nbqrm -P sles_idc -r user=dslov sles_idc.82381659
Or 
nbqrm -P sles_idc -a -r user=dslov 223850182        //-a for all (including waiting), -r - running only
Log file extract:
| Job id         : 133447382                  Class: x86_64       Qslot: /32G_Per_Job|
| Executed on    : icsl7067                   Pool : sles_idc                 |
| Command        : nbq.pl -remote -host icsl8107 -port 50411                  |
nbstat -p sles_exp | egrep 'STATUS| icsl6871'


output:
SERVER          STATUS      LOAD    	  USERS  IDLE     SEL  LAST SELECT     ON SINCE  
icsl6871              2 R 	 9.90/16.00/24.00    0/100	 30/30        9873     26 Oct 11:56    28 Sep 12:05

nbqstat -p sles_exp | egrep '^State|icsl6871'        example of checking the job's status

output:
State   JobID Class        Slot           User       Command                   Jobname/Server
Run      135948574  x86_64   5       nsucher  /nfs/site/proj/mpg/cad_suse/em64t_l icsl6871
Run      135977074  x86_64   5       dslov    /p/mpg/proc/common2/utils/tool_util icsl6871

nbq -P iil_design -Q <qslot_name> [-C <class_name>] <your command>

nbq options:
-C    - class name (x86_64, )	
-Q    - queue Slot Name 
-P xx  - send job to pool 'xx'
For example:
nbq -P sles_exp -Q red_8_1  <your command> -  submit a 8G, 1 core  job  
nbqstat  -p iil_design user=dslov
netbatch log may be found in the current directory: its name starts with # symbol (type most # and <tab> to see the log's name)
To view the memory consumption of your job please run (applies only for jobs that were sent no more than a week ago):

nbquery -T7D -FmaxRSS::30 --query-timeout 9999 jobid=`echo iil_mmg1.21713160 | cut -d. -f2`

Mickey's aliases:
# Net batch common aliases

alias nbidc2exp 'nbqrm -a -Psles_idc -Msles_exp -Q5'
nbqrm -a -P sles_exp -M iil_design -Q all_8 248955361 248955362 248955363 248955364
alias nbuserexp "nbqstat -p sles_exp user=$USER"
alias nbuseridc "nbqstat -p sles_idc user=$USER"
alias nbqexp "nbq -Psles_exp -C32G -Q5"
alias nbqalone "nbq -Psles_exp -Q/32G"
alias nbqrmexp "nbqrm -a -Psles_exp"
alias nbqrmidc "nbqrm -a -Psles_idc"

# iid_design Qslots
alias nbq4G  "nbq -P iil_design -Q all_4"
alias nbq8G  "nbq -P iil_design -Q all_8"
alias nbq16G "nbq -P iil_design -Q all_16"
alias nbq32G "nbq -P iil_design -Q all_32"


In order to optimize computing allocation and design batch utilization, we decided to open the new iil_design netbatch pool for all SNB/IVB IDC designers.
For this purposes we created qslot tree under /allocated/design/all  with wide range of  subqlosts  to serve different memory/cpu reservation
The main difference between iil_design pool and sles_exp is that it enables to reserve resource per-job. In other words, one can "reserve" 16G and 2 CPU core for a given job.
Below is the table  mapping qslots to its resource reservation - 

Qslot	Alias	Memory reservation	Cpu cores reservation	Constraint  to kill	maxrunning per user
/allocated/design/all/4G	all_4	4Gb	1	6Gb	10
/allocated/design/all/8G	all_8	8Gb	1	10Gb	5
/allocated/design/all/8G_2C
/allocated/design/all/8G_4C 	all_8_2C
all_8_4C	8Gb
7Gb	2
4		
/allocated/design/all/16G
/allocated/design/all/16G_2C
/allocated/design/all/16G_4C
/allocated/design/all/16G_8C	all_16
all_16_2C
all_16_4C
all_16_8C	16Gb
16Gb
16Gb
16Gb	1
2
4
8	20Gb	2
/allocated/design/all/32G
/allocated/design/all/32G_2C
/allocated/design/all/32G_4C 
/allocated/design/all/32G_8C 	all_32
all_32_2C
all_32_4C
all_32_8C	32Gb
32Gb
32Gb
32GB	1
2
4
8	40Gb	1

Example of submitting job  - 

nbq -P iil_design -Q all_8 <command> - Submit job to qslot which will reserve you job 8Gb memory slot

nbq -P iil_design -Q all_16_2C <command> - Submit job to qslot which will reserve you job 16Gb memory and 2 cores job slot.

Alternative command to get 16Gb and  4 cores - 
nbq -P iil_design -Q all_16 -cr "cpuslot=4" <command > 

